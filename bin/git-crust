#!/bin/bash

# Safely removes local branches that don't exist on remote origin anymore.
#
# Usage:
#   git crust
#
# Safety:
#   ðŸ›¡ï¸ Protects: main
#   ðŸ“ Logs to: ~/.git-crust-log
#   âœ… Requires confirmation

# Fail fast if not in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "ðŸª² Error: Not in a git repository" >&2
  exit 1
fi

# First fetch and prune to ensure our remote refs are up to date
git fetch --prune

# Set up log file with timestamp
LOG_FILE=~/.git-crust-log
echo "--- ðŸ¥ª Git Crust Run $(date '+%Y-%m-%d %H:%M:%S') ---" >> "$LOG_FILE"
echo "ðŸŽ Repo CWD: $(pwd)" >> "$LOG_FILE"

# Get local branches (excluding main & current branch)
current_branch=$(git rev-parse --abbrev-ref HEAD)
local_branches=$(git branch | grep -v "main" | grep -v "$current_branch" | sed 's/^[ *]*//')

# Get remote branches (strip origin/ prefix)
remote_branches=$(git branch -r | grep "origin/" | sed 's/origin\///')

# Track if we found any branches to delete
found_branches=false

for branch in $local_branches; do
  if ! echo "$remote_branches" | grep -q "^$branch$"; then
    if [ "$found_branches" = false ]; then
      echo "â— Branches to delete:"
      found_branches=true
    fi
    sha=$(git rev-parse "$branch")
    echo "ðŸ“ Found: \`$branch\` ($sha)"
    echo "ðŸ“ Found: \`$branch\` ($sha)" >> "$LOG_FILE"
  fi
done

# Exit if no branches found to delete
if [ "$found_branches" = false ]; then
  echo "No branches to clean! ðŸŽ‰"
  exit 0
fi

read -p "Continue? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
  for branch in $local_branches; do
    if ! echo "$remote_branches" | grep -q "^$branch$"; then
      sha=$(git rev-parse "$branch")
      echo "ðŸ’¥ Deleted: \`$branch\` ($sha)"
      echo "ðŸ’¥ Deleted: \`$branch\` ($sha)" >> "$LOG_FILE"
      git branch -D "$branch"
    fi
  done
fi
