#!/bin/bash

# Safely removes local branches that don't exist on remote origin anymore.
#
# Usage:
#   git crust
#
# Safety:
#   ðŸ›¡ï¸ Protects: main
#   ðŸ“ Logs to: ~/.git-crust-log
#   âœ… Requires confirmation

# Fail fast if not in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "ðŸª² Error: Not in a git repository" >&2
  exit 1
fi

# First fetch and prune to ensure our remote refs are up to date
git fetch --prune

# Set up log file with timestamp
LOG_FILE=~/.git-crust-log
echo "--- Git Crust Run $(date '+%Y-%m-%d %H:%M:%S') ---" >> "$LOG_FILE"
echo "Repo CWD: $(pwd)" >> "$LOG_FILE"

# Get local branches (excluding main)
local_branches=$(git branch | grep -v "main" | sed 's/^[ *]*//')

# Get remote branches (strip origin/ prefix)
remote_branches=$(git branch -r | grep "origin/" | sed 's/origin\///')

echo "The following local branches will be deleted (they don't exist on remote):"
for branch in $local_branches; do
  if ! echo "$remote_branches" | grep -q "^$branch$"; then
    sha=$(git rev-parse "$branch")
    echo "Found: $branch ($sha)"
    echo "Found: $branch ($sha)" >> "$LOG_FILE"
  fi
done

read -p "Continue? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
  for branch in $local_branches; do
    if ! echo "$remote_branches" | grep -q "^$branch$"; then
      sha=$(git rev-parse "$branch")
      echo "Deleted: $branch ($sha)"
      echo "Deleted: $branch ($sha)" >> "$LOG_FILE"
      git branch -D "$branch"
    fi
  done
fi
