#!/bin/bash

# linear-branch-decorator üè∑Ô∏è
# Appends Linear ticket title to branch names.
# Requires LINEAR_KEY environment variable.
#
# Usage:
#   linear-branch-decorator bschmeisser/web-3300     # Adds ticket title
#   linear-branch-decorator -v bschmeisser/web-3300  # Verbose output
#
# Example:
#   Input:  bschmeisser/web-3300
#   Output: bschmeisser/web-3300-add-auth-docs

# Ensure LINEAR_KEY is set
if [ -z "$LINEAR_KEY" ]; then
  echo "Error: LINEAR_KEY environment variable is not set."
  exit 1
fi

# Parse arguments for verbose mode
VERBOSE=false
if [ "$1" == "-v" ]; then
  VERBOSE=true
  shift
fi

# Ensure a branch name is provided
if [ -z "$1" ]; then
  echo "Usage: $0 [-v] <branch-name>"
  echo "Example: $0 bschmeisser/web-3300"
  echo "Example (verbose): $0 -v bschmeisser/web-3300"
  exit 1
fi

# Extract the ticket ID from the branch name
BRANCH="$1"
TICKET_ID=$(echo "$BRANCH" | grep -oE '[a-z]+-[0-9]+')

if [ -z "$TICKET_ID" ]; then
  echo "Error: Unable to extract ticket ID from branch name."
  exit 1
fi

# Inline the GraphQL query
QUERY="{ \"query\": \"query { issue(id: \\\"$TICKET_ID\\\") { id title description } }\" }"

if $VERBOSE; then
  echo "Debug: Query payload: $QUERY"
fi

# Query the Linear API
RESPONSE=$(curl -s -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: $LINEAR_KEY" \
  --data "$QUERY" \
  https://api.linear.app/graphql)

if $VERBOSE; then
  echo "Debug: cURL response: $RESPONSE"
fi

# Extract the title from the JSON response
TITLE=$(echo "$RESPONSE" | jq -r '.data.issue.title' 2>/dev/null)

if [ -z "$TITLE" ] || [ "$TITLE" == "null" ]; then
  echo "Error: Unable to fetch issue title. Response: $RESPONSE"
  exit 1
fi

# Clean up the title for the branch name
TITLE_SLUG=$(echo "$TITLE" | \
  tr '[:upper:]' '[:lower:]' | \
  sed -E 's/[^a-z0-9]+/-/g' | \
  sed -E 's/^-+|-+$//g')

# Append the slugged title to the original branch
NEW_BRANCH="${BRANCH}-${TITLE_SLUG}"

# Output only the branch name unless in verbose mode
if $VERBOSE; then
  echo "New branch name: $NEW_BRANCH"
else
  echo "$NEW_BRANCH"
fi
